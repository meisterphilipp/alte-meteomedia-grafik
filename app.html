<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>DWD MOSMIX – Kompakt</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  font-size: 12px;
}
.controls {
  margin-bottom: 6px;
}
#dayHeader {
  display: flex;
  font-weight: bold;
}
#stationName {
  font-weight:bold;
  margin-bottom:6px;
}
.panel {
  margin-bottom: 6px;
}
.panel-title {
  font-size: 11px;
  margin-bottom: 1px;
}
.chart-wrap {
  width: 100%;
  height: 85px;
}
.chart-wrap.small {
  height: 65px;
}
canvas {
  width: 100% !important;
  height: 100% !important;
}
#outer {
  position:fixed;
  width:800px;
  padding: 10px;
  border: 1px solid grey;
  background-color: #f8f8f8;
}
#source {
  position: absolute;
  top: 0px;
  right: 0px;
  padding: 4px;
}

</style>
</head>
<body>

<div class="controls">
  <input id="stationSearch" type="text" placeholder="Stationen filtern …" style="width:150px; margin-bottom:4px;">
  <select id="stationSelector" onchange="loadStation()">
    <option value="">Station wählen …</option>
  </select>
</div>

<div id="outer">
  <div id="stationName"></div>
  <div id="source">Quelle: <a href="https://opendata.dwd.de/">DWD MOSMIX L</a></div>

  <div id="dayHeader"></div>

  <div class="panel">
    <div class="panel-title">Temperatur °C</div>
    <div class="chart-wrap">
      <canvas id="cTemp"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Wind / Böen km/h</div>
    <div class="chart-wrap" style="position: relative;">
      <canvas id="cWind"></canvas>
      <canvas id="cWindArrow" style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
    </div>
  </div>


  <div class="panel">
    <div class="panel-title">Relative Luftfeuchte %</div>
    <div class="chart-wrap small">
      <canvas id="cRH"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Sonnenscheindauer min/h</div>
    <div class="chart-wrap">
      <canvas id="cSun"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Niederschlag mm/h</div>
    <div class="chart-wrap">
      <canvas id="cRain"></canvas>
    </div>
  </div>
</div>
<script>
/* ===============================
   CORS Proxy
   =============================== */
const CORS = u => "https://corsproxy.io/?" + u;
let allStations = [];

function dwdUrl(id) {
  return "https://opendata.dwd.de/weather/local_forecasts/mos/MOSMIX_L/" +
         "single_stations/" + id +
         "/kml/MOSMIX_L_LATEST_" + id + ".kmz";
}

/* ===============================
   XML Helper
   =============================== */
const byLocal = (xml, n) =>
  [...xml.getElementsByTagName("*")].filter(e => e.localName === n);

/* ===============================
   Load
   =============================== */
async function loadStation() {
  const sel = document.getElementById("stationSelector");
  const id = sel.value;
  if (!id) return;

  // URL‑Parameter setzen
  const params = new URLSearchParams(window.location.search);
  params.set("station", id);
  history.replaceState(null, "", "?" + params.toString());

  const resp = await fetch(CORS(dwdUrl(id)));
  const zip = await JSZip.loadAsync(await resp.arrayBuffer());
  const kml = await zip.file(/\.kml$/i)[0].async("text");

  renderAll(parseKML(kml));

  // Stationsname extrahieren
  const xml = new DOMParser().parseFromString(kml, "text/xml");
  const nameEl = xml.getElementsByTagNameNS("*", "description")[0];
  const stationName = nameEl ? nameEl.textContent : "Station " + id;

  document.getElementById("stationName").textContent = "Station: " + stationName;
}

async function loadStationList() {
  const url = "https://www.dwd.de/DE/leistungen/met_verfahren_mosmix/mosmix_stationskatalog.cfg?view=nasPublication&nn=16102";
  const resp = await fetch(CORS(url));
  const text = await resp.text();

  const sel = document.getElementById("stationSelector");

  const stations = [];

  text.split("\n").forEach(line => {
    const cols = line.trim().split(/\s+/, 3);
    if (cols.length > 2) {
      stations.push({
        id: cols[0],
        name: cols[2]
      });
    }
  });

  // alphabetisch nach Stationsname sortieren
  stations.sort((a, b) =>
    a.name.localeCompare(b.name, "de", { sensitivity: "base" })
  );

  allStations = stations;   // nach dem Sortieren
  renderStationOptions(allStations);

  // URL-Parameter auslesen
  const params = new URLSearchParams(window.location.search);
  const preset = params.get("station");
  if (preset) {
    sel.value = preset;
    loadStation();
  }
}

function renderStationOptions(list) {
  const sel = document.getElementById("stationSelector");
  sel.innerHTML = '<option value="">Station wählen …</option>';

  list.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name} (${s.id})`;
    sel.appendChild(opt);
  });
}

document.getElementById("stationSearch").addEventListener("input", e => {
  const q = e.target.value.trim().toLowerCase();

  const filtered = allStations.filter(s =>
    s.name.toLowerCase().includes(q) ||
    s.id.includes(q)
  );

  renderStationOptions(filtered);
});

function drawWindArrows(cId, windDir, times) {
  const canvas = document.getElementById(cId);
  const ctx = canvas.getContext("2d");

  // Größe anpassen, passend zum Chart
  const chartCanvas = document.getElementById("cWind");
  canvas.width = chartCanvas.width;
  canvas.height = chartCanvas.height;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  const arrowLength = 20;

  const step = times.length > 48 ? Math.floor(times.length / 48) : 1;

  windDir.forEach((deg,i)=>{
    if(deg==null || i % step !== 0) return;

    const px = (i/(times.length-1))*canvas.width;
    const py = canvas.height-20;

    ctx.save();
    ctx.translate(px, py);
    ctx.rotate((deg-180)*Math.PI/180);
    ctx.beginPath();
    ctx.moveTo(0, -arrowLength/2);
    ctx.lineTo(arrowLength/2, arrowLength/2);
    ctx.lineTo(0, arrowLength/4);
    ctx.lineTo(-1, arrowLength/4);
    ctx.lineTo(-1, arrowLength);
    ctx.lineTo(2, arrowLength);
    ctx.lineTo(2, arrowLength/4);
    ctx.lineTo(0, arrowLength/4);
    ctx.lineTo(-arrowLength/2, arrowLength/2);
    ctx.closePath();
    ctx.fillStyle = "black";
    ctx.fill();
    ctx.restore();
  });
}

function gridX(times, canvasWidth) {
  return i => (i / (times.length-1)) * canvasWidth;
}


loadStationList();


/* ===============================
   Parse + Tagesstart 00:00
   =============================== */
function parseKML(text) {
  const xml = new DOMParser().parseFromString(text, "text/xml");

  // vorhandene Times
  let timesRaw = byLocal(xml, "TimeStep").map(n => new Date(n.textContent));

  // Forecast-Daten
  const raw = {};
  byLocal(xml, "Forecast").forEach(f => {
    const n = f.getAttribute("dwd:elementName") || f.getAttribute("elementName");
    const v = [...f.children].find(c => c.localName === "value");
    if (n && v)
      raw[n] = v.textContent.trim().split(/\s+/).map(x => x === "-" ? null : +x);
  });

  // Heute 00:00 bis 4 Tage später, stündlich
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(start);
  end.setDate(end.getDate() + 4);

  const times = [];
  for (let t = new Date(start); t < end; t.setHours(t.getHours() + 1)) {
    times.push(new Date(t));
  }

  const sel = arr => times.map(t => {
    const idx = timesRaw.findIndex(tr => tr.getTime() === t.getTime());
    return idx >= 0 ? arr[idx] : null;
  });

  const temp = sel(raw.TTT).map(v => v==null?null:v-273.15);
  const dew  = sel(raw.Td).map(v => v==null?null:v-273.15);
  const sun  = sel(raw.SunD1).map(v => v==null?null:v/60);
  const windDir = sel(raw.DD);
  const rain = sel(raw.RR1c);
  const wind = sel(raw.FF).map(v => v==null?null:v * 3.6);
  const gust = sel(raw.FX1).map(v => v==null?null:v * 3.6);

  // Relative Luftfeuchte
  const rh = temp.map((t,i)=>{
    const d=dew[i];
    if(t==null||d==null)return null;
    const a=17.62,b=243.12;
    return Math.max(0,Math.min(100,
      100*Math.exp(a*d/(b+d))/Math.exp(a*t/(b+t))
    ));
  });

  // Windrichtung
  const arrowsPerDay = 12; // 24h / 2h = 12
  const step = Math.floor(times.length / (4*arrowsPerDay)); // 4 Tage
  const windDirSampled = times.map((_, i) => (i % step === 0 ? windDir[i] : null));

  return {
    times,
    temp,
    wind,
    gust,
    rh,
    sun,
    rain,
    windDirSampled
  };
}

/* ===============================
   Grid
   =============================== */
function gridInfo(times){
  const days=[],hours=[];
  times.forEach((t,i)=>{
    if(t.getHours()===0) days.push({i,t});
    if([0,6,12,18].includes(t.getHours())) hours.push({i});
  });
  return {days,hours};
}

const gridPlugin={
  id:"grid",
  afterDraw(c,a,o){
    const {ctx,chartArea:{top,bottom},scales:{x}}=c;
    ctx.save();
    o.hours.forEach(h=>{
      const px=x.getPixelForValue(h.i);
      ctx.strokeStyle="#777";
      ctx.lineWidth=0.4;
      ctx.beginPath();ctx.moveTo(px,top);ctx.lineTo(px,bottom);ctx.stroke();
    });
    o.days.forEach(d=>{
      const px=x.getPixelForValue(d.i);
      ctx.strokeStyle="#000";
      ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(px,top);ctx.lineTo(px,bottom);ctx.stroke();
    });
    ctx.restore();
  }
};

/* ===============================
   Render
   =============================== */
let charts=[];
function renderAll(d){
  charts.forEach(c=>c.destroy()); charts=[];
  const labels=d.times.map((_,i)=>i);
  const grid=gridInfo(d.times);
  renderHeader(d.times,grid.days);

  const tMin = Math.min(...d.temp.filter(v => v != null));
  const tempScale = {beginAtZero: false};
  if (tMin < 5 && tMin >= 0) {tempScale.min = 0;}


  charts.push(line("cTemp",labels,d.temp,"black",grid,null,[zeroLinePlugin],tempScale));
  charts.push(line("cWind",labels,d.wind,"olive",grid,d.gust,[],{min: 0}));
  charts.push(line("cRH",labels,d.rh,"teal",grid));
  charts.push(bar("cSun",labels,d.sun,"gold",grid,{beginAtZero: false, max: 60}));
  charts.push(
    new Chart(document.getElementById("cRain"), {
      type: "bar",
      plugins: [gridPlugin],
      data: {
        labels,
        datasets: [{
          data: d.rain,
          backgroundColor: "blue",
          barPercentage: .8
        }]
      },
      options: opts(grid, {suggestedMax: 0.5}, true, d.times) // ← X-Achse an
    })
  );
  drawWindArrows("cWindArrow", d.windDirSampled, d.times);
}

function renderHeader(times,days){
  const el=document.getElementById("dayHeader");
  el.innerHTML="";
  days.forEach((d,i)=>{
    const div=document.createElement("div");
    div.style.flex=( (i+1<days.length?days[i+1].i:times.length) - d.i );
    div.style.textAlign="center";
    div.textContent=d.t.toLocaleDateString("de-DE",{weekday:"short",day:"2-digit",month:"2-digit"});
    el.appendChild(div);
  });
}

/* ===============================
   Charts
   =============================== */
function opts(grid, yScaleOverride = null, showX = false, times = null) {
  return{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{legend:{display:false},grid:{days:grid.days,hours:grid.hours}},
    scales: {
      x: {
        display: showX,
        ticks: showX && times ? {
          autoSkip: false,
          callback: (value) => hourLabel(times, value),
          maxRotation: 0,
          minRotation: 0,
          font: { size: 10 }
        } : undefined,
        grid: { display: false }
      },
      ...(yScaleOverride ? { y: yScaleOverride} : {})
    }
  };
}

function hourLabel(times, index) {
  const h = times[index].getHours();
  return [0, 6, 12, 18].includes(h)
    ? h.toString().padStart(2, "0")
    : "";
}

function line(id, l, data, color, grid, extra, plugins = [], yScaleOverride = null) {
  return new Chart(document.getElementById(id),{
    type:"line",plugins:[gridPlugin, ...plugins],
    data:{labels:l,datasets:[
      {data,borderColor:color,pointRadius:0,tension:.3,borderWidth:2},
      ...(extra?[{data:extra,borderColor:"magenta",borderDash:[4,3],pointRadius:0}]:[])
    ]},
    options:opts(grid, yScaleOverride)
  });
}

function bar(id,l,data,color,grid, yScaleOverride = null){
  return new Chart(document.getElementById(id),{
    type:"bar",plugins:[gridPlugin],
    data:{labels:l,datasets:[{data,backgroundColor:color,barPercentage:1}]},
    options:opts(grid, yScaleOverride)
  });
}

const zeroLinePlugin = {
  id: "zeroLine",
  afterDraw(chart) {
    const y = chart.scales.y;
    if (!y) return;

    // prüfen, ob 0°C im sichtbaren Bereich liegt
    if (y.min > 0 || y.max < 0) return;

    const y0 = y.getPixelForValue(0);
    const { left, right } = chart.chartArea;
    const ctx = chart.ctx;

    ctx.save();
    ctx.strokeStyle = "#444";
    ctx.lineWidth = 1;
    ctx.setLineDash([6, 4]); // gestrichelt
    ctx.beginPath();
    ctx.moveTo(left, y0);
    ctx.lineTo(right, y0);
    ctx.stroke();
    ctx.restore();
  }
};

</script>

</body>
</html>
