<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>DWD MOSMIX – Kompakt</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
:root {
  --color-bg: #ffffff;
  --color-text: #111111;
  --color-text-light: #666666;
  --color-link: #906fc4;
  --color-link-hover: #68479d;
  --color-app-bg: #f8f8f8;
  --color-app-border: #dddddd;
  --color-graph-temp: #000;
  --color-graph-wind: #808000;
  --color-graph-gust: #ff00ff;
  --color-graph-winddir: #000;
  --color-graph-humidity: #008080;
  --color-graph-sun: #ffd700;
  --color-graph-rain: #0000ff;
}
@media (prefers-color-scheme: dark) {
  :root {
    --color-bg: #0f1115;
    --color-text: #a9a9a9;
    --color-text-light: #666666;
    --color-link: #6d48aa;
    --color-link-hover: #a487d2;
    --color-app-bg: #262626;
    --color-app-border: #828282;
    --color-graph-temp: #b0b0b0;
    --color-graph-wind: #808000;
    --color-graph-gust: #ff00ff;
    --color-graph-winddir: #777777;
    --color-graph-humidity: #008080;
    --color-graph-sun: #c9ab00;
    --color-graph-rain: #0000c5;
  }
}
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  font-size: 12px;
  background-color: var(--color-bg);
  color: var(--color-text);
}
a {
  color: var(--color-link);
}
a:hover {
  color: var(--color-link-hover);
}
.controls {
  margin-bottom: 6px;
}
#stationName {
  font-weight:bold;
  margin-bottom:6px;
}
.panel {
  margin-bottom: 6px;
}
.chart-wrap {
  width: 100%;
  height: 85px;
}
.chart-wrap.small {
  height: 65px;
}
.chart-wrap.large {
  height: 105px;
}
canvas {
  width: 100% !important;
  height: 100% !important;
}
#app {
  position:fixed;
  width:800px;
  padding: 10px;
  border: 1px solid var(--color-app-border);
  background-color: var(--color-app-bg);
}
#metadata {
  position: absolute;
  top: 0px;
  right: 0px;
  padding: 4px;
}
#stationSearch {
  width:150px;
  margin-bottom:4px;
  padding: 2px;
  background-color: var(--color-app-bg);
  border: 1px solid var(--color-app-border);
  color: var(--color-text);
}
#stationSelector {
  padding: 2px;
  background-color: var(--color-app-bg);
  border: 1px solid var(--color-app-border);
  color: var(--color-text);
}
</style>
</head>
<body>

<div class="controls">
  <input id="stationSearch" type="text" placeholder="Stationen filtern …">
  <select id="stationSelector" onchange="loadStation()">
    <option value="">Station wählen …</option>
  </select>
</div>

<div id="app">
  <div id="stationName">Station:</div>
  <div id="metadata">Quelle: <a href="https://opendata.dwd.de/">DWD MOSMIX L</a></div>

  <div class="panel">
    <div class="panel-title" style="margin-bottom: -20px;">Temperatur °C</div>
    <div class="chart-wrap large">
      <canvas id="cTemp"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Wind / Böen km/h</div>
    <div class="chart-wrap" style="position: relative;">
      <canvas id="cWind"></canvas>
      <canvas id="cWindArrow" style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
    </div>
  </div>


  <div class="panel">
    <div class="panel-title">Relative Luftfeuchte %</div>
    <div class="chart-wrap small">
      <canvas id="cRH"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Sonnenscheindauer min/h</div>
    <div class="chart-wrap">
      <canvas id="cSun"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Niederschlag mm/h</div>
    <div class="chart-wrap">
      <canvas id="cRain"></canvas>
    </div>
  </div>
</div>
<script>

/* ===============================
   URL Settings
   =============================== */
const CORS = u => "https://corsproxy.io/?" + u;


function dwdUrl(id) {
  return "https://opendata.dwd.de/weather/local_forecasts/mos/MOSMIX_L/" +
         "single_stations/" + id +
         "/kml/MOSMIX_L_LATEST_" + id + ".kmz";
}

/* ===============================
   Load stations
   =============================== */
let allStations = [];

const byLocal = (xml, n) =>
  [...xml.getElementsByTagName("*")].filter(e => e.localName === n);

async function loadStation() {
  const sel = document.getElementById("stationSelector");
  const id = sel.value;
  if (!id) return;

  // URL‑Parameter setzen
  const params = new URLSearchParams(window.location.search);
  params.set("station", id);
  history.replaceState(null, "", "?" + params.toString());

  const resp = await fetch(CORS(dwdUrl(id)));
  const zip = await JSZip.loadAsync(await resp.arrayBuffer());
  const kml = await zip.file(/\.kml$/i)[0].async("text");

  renderAll(parseKML(kml));

  // Stationsname extrahieren
  const xml = new DOMParser().parseFromString(kml, "text/xml");
  const nameEl = xml.getElementsByTagNameNS("*", "description")[0];
  const stationName = nameEl ? nameEl.textContent : "Station " + id;

  document.getElementById("stationName").textContent = "Station: " + stationName;
}

async function loadStationList() {
  const url = "https://www.dwd.de/DE/leistungen/met_verfahren_mosmix/mosmix_stationskatalog.cfg?view=nasPublication&nn=16102";
  const resp = await fetch(CORS(url));
  const text = await resp.text();

  const sel = document.getElementById("stationSelector");

  const stations = [];

  text.split("\n").forEach(line => {
    const cols = line.trim().split(/\s+/, 3);
    if (cols.length > 2) {
      stations.push({
        id: cols[0],
        name: cols[2]
      });
    }
  });

  // alphabetisch nach Stationsname sortieren
  stations.sort((a, b) =>
    a.name.localeCompare(b.name, "de", { sensitivity: "base" })
  );

  allStations = stations;   // nach dem Sortieren
  renderStationOptions(allStations);

  // URL-Parameter auslesen
  const params = new URLSearchParams(window.location.search);
  const preset = params.get("station");
  if (preset) {
    sel.value = preset;
    loadStation();
  }
}

function renderStationOptions(list) {
  const sel = document.getElementById("stationSelector");
  sel.innerHTML = '<option value="">Station wählen …</option>';

  list.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name} (${s.id})`;
    sel.appendChild(opt);
  });
}

document.getElementById("stationSearch").addEventListener("input", e => {
  const q = e.target.value.trim().toLowerCase();

  const filtered = allStations.filter(s =>
    s.name.toLowerCase().includes(q) ||
    s.id.includes(q)
  );

  renderStationOptions(filtered);
});

loadStationList();


/* ===============================
   Parse KML data
   =============================== */
function parseKML(text) {
  const xml = new DOMParser().parseFromString(text, "text/xml");

  // vorhandene Times
  let timesRaw = byLocal(xml, "TimeStep").map(n => new Date(n.textContent));

  // Forecast-Daten
  const raw = {};
  byLocal(xml, "Forecast").forEach(f => {
    const n = f.getAttribute("dwd:elementName") || f.getAttribute("elementName");
    const v = [...f.children].find(c => c.localName === "value");
    if (n && v)
      raw[n] = v.textContent.trim().split(/\s+/).map(x => x === "-" ? null : +x);
  });

  // Heute 00:00 bis 4 Tage später, stündlich
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(start);
  end.setDate(end.getDate() + 4);

  const times = [];
  for (let t = new Date(start); t < end; t.setHours(t.getHours() + 1)) {
    times.push(new Date(t));
  }

  const sel = arr => times.map(t => {
    const idx = timesRaw.findIndex(tr => tr.getTime() === t.getTime());
    return idx >= 0 ? arr[idx] : null;
  });

  const temp = sel(raw.TTT).map(v => v==null?null:v-273.15);
  const dew  = sel(raw.Td).map(v => v==null?null:v-273.15);
  const sun  = sel(raw.SunD1).map(v => v==null?null:v/60);
  const windDir = sel(raw.DD);
  const rain = sel(raw.RR1c);
  const wind = sel(raw.FF).map(v => v==null?null:v * 3.6);
  const gust = sel(raw.FX1).map(v => v==null?null:v * 3.6);

  // Relative Luftfeuchte
  const rh = temp.map((t,i)=>{
    const d=dew[i];
    if(t==null||d==null)return null;
    const a=17.62,b=243.12;
    return Math.max(0,Math.min(100,
      100*Math.exp(a*d/(b+d))/Math.exp(a*t/(b+t))
    ));
  });

  // Windrichtung
  const arrowsPerDay = 12; // 24h / 2h = 12
  const step = Math.floor(times.length / (4*arrowsPerDay)); // 4 Tage
  const windDirSampled = times.map((_, i) => (i % step === 0 ? windDir[i] : null));

  return {
    times,
    temp,
    wind,
    gust,
    rh,
    sun,
    rain,
    windDirSampled
  };
}

/* ===============================
   Plugins
   =============================== */
const gridPlugin={
  id:"grid",
  beforeDraw(c,a,o){
    const {ctx,chartArea:{top,bottom},scales:{x}}=c;
    ctx.save();
    o.hours.forEach(h=>{
      const px=x.getPixelForValue(h.i);
      ctx.strokeStyle=cssVar("--color-text-light");
      ctx.lineWidth=0.4;
      ctx.beginPath();ctx.moveTo(px,top);ctx.lineTo(px,bottom);ctx.stroke();
    });
    ctx.restore();
  },
  afterDraw(c,a,o){
    const {ctx,chartArea:{top,bottom},scales:{x}}=c;
    ctx.save();
    o.days.forEach(d=>{
      const px=x.getPixelForValue(d.i);
      ctx.strokeStyle=cssVar("--color-text");
      ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(px,top);ctx.lineTo(px,bottom);ctx.stroke();
    });
    ctx.restore();
  }
};

const zeroLinePlugin = {
  id: "zeroLine",
  afterDraw(chart) {
    const y = chart.scales.y;
    if (!y) return;

    // prüfen, ob 0°C im sichtbaren Bereich liegt
    if (y.min > 0 || y.max < 0) return;

    const y0 = y.getPixelForValue(0);
    const { left, right } = chart.chartArea;
    const ctx = chart.ctx;

    ctx.save();
    ctx.strokeStyle = cssVar("--color-text-light");
    ctx.lineWidth = 1;
    ctx.setLineDash([6, 4]); // gestrichelt
    ctx.beginPath();
    ctx.moveTo(left, y0);
    ctx.lineTo(right, y0);
    ctx.stroke();
    ctx.restore();
  }
};

const windArrowPlugin = {
  afterDraw(chart) {
    const dirs = chart.$windDirSampled;
    if (!dirs) return;

    const { ctx, scales: { x }, chartArea } = chart;
    const y = chartArea.bottom + 6;

    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "13px system-ui";
    ctx.fillStyle = cssVar("--color-graph-winddir");

    dirs.forEach((dd, i) => {
      if (dd == null || isNaN(dd)) return;
      const px = x.getPixelForValue(i);

      ctx.save();
      ctx.translate(px, y);
      ctx.rotate((dd + 180) * Math.PI / 180);
      ctx.fillText("↑", 0, 0);
      ctx.restore();
    });
  }
};


/* ===============================
   Render
   =============================== */
let charts=[];
function renderAll(d){
  charts.forEach(c=>c.destroy()); charts=[];
  const labels=d.times.map((_,i)=>i);
  const grid=gridInfo(d.times);

  const tMin = Math.min(...d.temp.filter(v => v != null));
  const tempScale = {beginAtZero: false};
  if (tMin < 5 && tMin >= 0) {tempScale.min = 0;}

  // Temp
  charts.push(
    new Chart(document.getElementById("cTemp"),{
      type:"line",
      plugins:[gridPlugin, zeroLinePlugin],
      data:{
        labels,
        datasets:[{
          data: d.temp,
          borderColor:cssVar("--color-graph-temp"),
          pointRadius:0,
          borderWidth:2
        }]
      },
      options:opts(grid, tempScale, false, d.times, true)
    })
  );

  // Wind
  const windChart = new Chart(document.getElementById("cWind"), {
    type: "line",
    plugins: [gridPlugin, windArrowPlugin],
    data: {
      labels,
      datasets:[
        {
          data: d.wind,
          borderColor:cssVar("--color-graph-wind"),
          pointRadius:0,
          borderWidth:2
        },
        {
          data: d.gust,
          borderColor:cssVar("--color-graph-gust"),
          borderDash:[4,3],
          pointRadius:0,
          borderWidth:2
        }
      ]
    },
    options: opts(grid, {min: 0})
  });
  windChart.$windDirSampled = d.windDirSampled;
  charts.push(windChart);

  // Humidity
  charts.push(
    new Chart(document.getElementById("cRH"),{
      type:"line",
      plugins:[gridPlugin],
      data:{
        labels,
        datasets:[{
          data: d.rh,
          borderColor:cssVar("--color-graph-humidity"),
          pointRadius:0,
          borderWidth:2
        }]
      },
      options:opts(grid)
    })
  );

  // Sun
  charts.push(
    new Chart(document.getElementById("cSun"), {
      type: "bar",
      plugins: [gridPlugin],
      data: {
        labels,
        datasets: [{
          data: d.sun,
          backgroundColor: cssVar("--color-graph-sun"),
          barPercentage: .8
        }]
      },
      options: opts(grid, {beginAtZero: false, max: 60}) // ← X-Achse an
    })
  );

  // Rain
  charts.push(
    new Chart(document.getElementById("cRain"), {
      type: "bar",
      plugins: [gridPlugin],
      data: {
        labels,
        datasets: [{
          data: d.rain,
          backgroundColor: cssVar("--color-graph-rain"),
          barPercentage: .8
        }]
      },
      options: opts(grid, {suggestedMax: 0.5}, true, d.times) // ← X-Achse an
    })
  );
}

/* ===============================
   Helper functions
   =============================== */

function opts(grid, y = {}, showX = false, times = null, showXTop = false) {
  return{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{legend:{display:false},grid:{days:grid.days,hours:grid.hours}},
    scales: {
      x: {
        display: showX,
        ticks: showX && times ? {
          autoSkip: false,
          callback: (value) => hourLabel(times, value),
          maxRotation: 0,
          minRotation: 0,
          font: { size: 10 },
          color: cssVar("--color-text-light")
        } : undefined,
        grid: { display: false }
      },
      xTop: {
        position: "top",
        display: showXTop,
        ticks: showXTop && times ? {
          autoSkip: false,
          callback: (v) => dayTicks(times)[v],
          maxRotation: 0,
          minRotation: 0,
          font: { size: 12, weight: "bold" },
          color: cssVar("--color-text"),
          padding: 4
        } : undefined,
        grid: { display: false }
      },
      y: {
        afterFit(scale) {
          scale.width = 28;
        },
        grid: {
          color: cssVar("--color-text-light"),
          lineWidth: 0.1
        },
        ...y
      }
    }
  };
}

function hourLabel(times, index) {
  const h = times[index].getHours();
  return [0, 6, 12, 18].includes(h)
    ? h.toString().padStart(2, "0")
    : "";
}

function dayTicks(times) {
  return times.map((t, i) =>
    t.getHours() === 12
      ? t.toLocaleDateString("de-DE", {
          weekday: "short",
          day: "2-digit",
          month: "2-digit"
        })
      : ""
  );
}

function cssVar(name) {
  return getComputedStyle(document.documentElement)
    .getPropertyValue(name)
    .trim();
}

function gridInfo(times){
  const days=[],hours=[];
  times.forEach((t,i)=>{
    if(t.getHours()===0) days.push({i,t});
    if([0,6,12,18].includes(t.getHours())) hours.push({i});
  });
  return {days,hours};
}

</script>

</body>
</html>
