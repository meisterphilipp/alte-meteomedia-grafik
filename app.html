<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DWD MOSMIX – Kompakt</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>


<style>
:root {
  --font-size: 12px;
  --font-size-small: 10px;
  --color-bg: #ffffff;
  --color-text: #111111;
  --color-text-light: #666666;
  --color-link: #906fc4;
  --color-link-hover: #68479d;
  --color-app-bg: #f8f8f8;
  --color-app-border: #dddddd;
  --color-graph-temp: #000;
  --color-graph-wind: #808000;
  --color-graph-gust: #ff00ff;
  --color-graph-winddir: #000;
  --color-graph-humidity: #008080;
  --color-graph-sun: #ffd700;
  --color-graph-rain: #0000ff;
}
:root[data-theme="dark"] {
  --color-bg: #0f1115;
  --color-text: #a9a9a9;
  --color-text-light: #666666;
  --color-link: #6d48aa;
  --color-link-hover: #a487d2;
  --color-app-bg: #262626;
  --color-app-border: #828282;
  --color-graph-temp: #b0b0b0;
  --color-graph-wind: #808000;
  --color-graph-gust: #ff00ff;
  --color-graph-winddir: #777777;
  --color-graph-humidity: #008080;
  --color-graph-sun: #c9ab00;
  --color-graph-rain: #0000c5;
}
html {
  -webkit-text-size-adjust: 100%;
}
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  font-size: var(--font-size);
  background-color: var(--color-bg);
  color: var(--color-text);
}
a {
  color: var(--color-link);
}
a:hover {
  color: var(--color-link-hover);
}
.controls {
  margin-bottom: 6px;
  width:820px;
  position: relative;
}
#stationName {
  font-weight:bold;
  margin-bottom:6px;
}
.panel {
  margin-bottom: 6px;
}
.chart-wrap {
  width: 100%;
  height: 85px;
}
.chart-wrap.small {
  height: 65px;
}
.chart-wrap.large {
  height: 105px;
}
canvas {
  width: 100% !important;
  height: 100% !important;
}
#app {
  position:relative;
  width:800px;
  padding: 10px;
  border: 1px solid var(--color-app-border);
  background-color: var(--color-app-bg);
}
#metadata {
  position: absolute;
  top: 0px;
  right: 0px;
  padding: 4px;
}
#stationSearch {
  width:150px;
  margin-bottom:4px;
  padding: 2px;
  background-color: var(--color-app-bg);
  border: 1px solid var(--color-app-border);
  color: var(--color-text);
}
#stationSelector {
  padding: 2px;
  background-color: var(--color-app-bg);
  border: 1px solid var(--color-app-border);
  color: var(--color-text);
  min-width: 300px;
}
#darkmode {
  display: inline;
  position:absolute;
  right: 0px;
}
#darkmodeSelector {
  padding: 2px;
  background-color: var(--color-app-bg);
  border: 1px solid var(--color-app-border);
  color: var(--color-text);
  font-size: var(--font-size);
}
#error {
  color: red;
  padding: 10px;
  margin-bottom: 20px;
  border: 1px solid grey;
  width:800px;
  font-weight: bold;
  display: none;
}
</style>
</head>
<body>

<div id="error"></div>

<div class="controls">
  <input id="stationSearch" type="text" placeholder="Stationen filtern …">
  <select id="stationSelector" onchange="changeStation(this.value)">
    <option value="">Liste wird geladen …</option>
  </select>
  <div id="darkmode">
    Darkmode:
    <select id="darkmodeSelector" onchange="changeDarkmode(this.value)">
      <option value="2">Systemeinstellung</option>
      <option value="1">An</option>
      <option value="0">Aus</option>
    </select>
  </div>
</div>

<div id="app">
  <div id="stationName">Station:</div>
  <div id="metadata">Quelle: DWD MOSMIX via <a target="_blank" href="https://brightsky.dev/">brightsky.dev</a></div>

  <div class="panel">
    <div class="panel-title" style="margin-bottom: -20px;">Temperatur °C</div>
    <div class="chart-wrap large">
      <canvas id="cTemp"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Wind / Böen km/h</div>
    <div class="chart-wrap" style="position: relative;">
      <canvas id="cWind"></canvas>
      <canvas id="cWindArrow" style="position:absolute; left:0; top:0; pointer-events:none;"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Relative Luftfeuchte %</div>
    <div class="chart-wrap small">
      <canvas id="cRH"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Sonnenscheindauer min/h</div>
    <div class="chart-wrap">
      <canvas id="cSun"></canvas>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Niederschlag mm/h</div>
    <div class="chart-wrap">
      <canvas id="cRain"></canvas>
    </div>
  </div>
</div>
<script>

/* ===============================
   URL Settings
   =============================== */
function brightSkyUrl(stationId) {
  const d = new Date();
  return `https://api.brightsky.dev/weather` +
         `?wmo_station_id=${stationId}` +
         `&date=${new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString()}` +
         `&last_date=${new Date(d.getFullYear(), d.getMonth(), d.getDate()+4,23,59,59).toISOString()}`;
}
//Mitte Deutschland + 500km für alle Stationen
function brightSkySourcesUrl() {
  return "https://api.brightsky.dev/sources" +
    "?lat=50.55718952310392" +
    "&lon=10.28123655125358" +
    "&max_dist=500000";
}

/* ===============================
   Load stations
   =============================== */
let allStations = [];

function changeStation(id) {
  const params = new URLSearchParams(window.location.search);
  params.set("station", id);
  history.replaceState(null, "", "?" + params.toString());
  loadStation();
}

async function loadStation() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("station");
  if (!id) return;

  try {
    // Request an Bright Sky mit DWD-Stations ID
    const resp = await fetch(brightSkyUrl(id));
    const json = await resp.json();

    if (!json.weather || json.weather.length === 0) {
      throw new Error("Keine Daten vom Bright Sky API erhalten");
    }

    const rows = json.weather;
    parsed = {
      times: rows.map(r => new Date(r.timestamp)),
      temp: rows.map(r => r.temperature),
      wind: rows.map(r => r.wind_speed),
      gust: rows.map(r => r.wind_gust_speed),
      sun: rows.map(r => r.sunshine),
      rain: rows.map(r => r.precipitation),
      windDirSampled: rows.map((r, i) => i % 2 === 0 ? r.wind_direction : null),
      rh: rows.map(r => {
        const T = r.temperature;
        const Td = r.dew_point;
        if (T == null || Td == null) return null;
        const eT = 6.112 * Math.exp(17.67 * T / (T + 243.5));
        const eTd = 6.112 * Math.exp(17.67 * Td / (Td + 243.5));
        return Math.min(100, Math.max(0, (eTd / eT) * 100));
      })
    };

    renderAll(parsed);

    // Display station name (optional: aus json.sources)
    const stationName = json.sources?.[0]?.station_name || id;
    document.getElementById("stationName").textContent =
      "Station: " + stationName;

  } catch (err) {
    display_error("Fehler beim Laden der Bright Sky Daten: " + err.message);
  }
}

async function loadStationList() {
  let json;

  try {
    const resp = await fetch(brightSkySourcesUrl());
    json = await resp.json();
  } catch {
    display_error("Bright Sky Stationsliste konnte nicht geladen werden.");
    return;
  }

  if (!Array.isArray(json.sources)) {
    display_error("Ungültige Antwort vom Bright Sky Sources Endpoint.");
    return;
  }

  const map = new Map();
  json.sources
    .filter(s => s.observation_type === "forecast")
    .forEach(s => {
    const key =
      s.wmo_station_id ??
      s.dwd_station_id ??
      s.id;

    if (!key) return;

    if (!map.has(key)) {
      map.set(key, {
        id: s.wmo_station_id || s.dwd_station_id || s.id,
        name: s.station_name || `Station ${key}`
      });
    }
  });

  // Sort
  allStations = [...map.values()].sort((a, b) =>
    a.name.localeCompare(b.name, "de", { sensitivity: "base" })
  );

  if (!allStations.length) {
    display_error("Keine Stationen aus Bright Sky Sources erhalten.");
    return;
  }

  renderStationOptions(allStations);

  // Set to station provided by url param
  const params = new URLSearchParams(window.location.search);
  const preset = params.get("station");
  if (preset && allStations.some(s => s.id === preset)) {
    document.getElementById("stationSelector").value = preset;
  }
}

function renderStationOptions(list) {
  const sel = document.getElementById("stationSelector");
  sel.innerHTML = '<option value="">Station wählen …</option>';

  list.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name} (${s.id})`;
    sel.appendChild(opt);
  });
}

/* ===============================
   Init
   =============================== */
document.getElementById("stationSearch").addEventListener("input", e => {
  const q = e.target.value.trim().toLowerCase();

  const filtered = allStations.filter(s =>
    s.name.toLowerCase().includes(q) ||
    s.id.includes(q)
  );

  renderStationOptions(filtered);
});
loadStation();
loadStationList();
setDarkmodeFromStorage();

/* ===============================
   Chart.js Plugins
   =============================== */
const gridPlugin={
  id:"grid",
  beforeDraw(c,a,o){
    const {ctx,chartArea:{top,bottom},scales:{x}}=c;
    ctx.save();
    o.hours.forEach(h=>{
      const px = x.getPixelForValue(h.t);

      ctx.strokeStyle=cssVar("--color-text-light");
      ctx.lineWidth=0.4;
      ctx.beginPath();ctx.moveTo(px,top);ctx.lineTo(px,bottom);ctx.stroke();
    });
    ctx.restore();
  },
  afterDraw(c,a,o){
    const {ctx,chartArea:{top,bottom},scales:{x}}=c;
    ctx.save();
    o.days.forEach(d=>{
      const px = x.getPixelForValue(d.t);

      ctx.strokeStyle=cssVar("--color-text");
      ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(px,top);ctx.lineTo(px,bottom);ctx.stroke();
    });
    ctx.restore();
  }
};

const zeroLinePlugin = {
  id: "zeroLine",
  afterDraw(chart) {
    const y = chart.scales.y;
    if (!y) return;

    // prüfen, ob 0°C im sichtbaren Bereich liegt
    if (y.min > 0 || y.max < 0) return;

    const y0 = y.getPixelForValue(0);
    const { left, right } = chart.chartArea;
    const ctx = chart.ctx;

    ctx.save();
    ctx.strokeStyle = cssVar("--color-text-light");
    ctx.lineWidth = 1;
    ctx.setLineDash([6, 4]); // gestrichelt
    ctx.beginPath();
    ctx.moveTo(left, y0);
    ctx.lineTo(right, y0);
    ctx.stroke();
    ctx.restore();
  }
};

const windArrowPlugin = {
  afterDraw(chart) {
    const dirs = chart.$windDirSampled;
    if (!dirs) return;

    const { ctx, scales: { x }, chartArea } = chart;
    const y = chartArea.bottom + 6;

    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "13px system-ui";
    ctx.fillStyle = cssVar("--color-graph-winddir");

    dirs.forEach((dd, i) => {
      if (dd == null || isNaN(dd)) return;
      const t = chart.$times?.[i];
      if (!(t instanceof Date)) return;

      const px = x.getPixelForValue(t);

      ctx.save();
      ctx.translate(px, y);
      ctx.rotate((dd + 180) * Math.PI / 180);
      ctx.fillText("↑", 0, 0);
      ctx.restore();
    });
  }
};


/* ===============================
   Render
   =============================== */
let charts=[];
function renderAll(d){
  charts.forEach(c=>c.destroy()); charts=[];
  const labels=d.times.map((_,i)=>i);
  const grid=gridInfo(d.times);

  const tMin = Math.min(...d.temp.filter(v => v != null));
  const tempScale = {beginAtZero: false};
  if (tMin < 5 && tMin >= 0) {tempScale.min = 0;}

  console.log(d);

  // Temp
  charts.push(
    new Chart(document.getElementById("cTemp"),{
      type:"line",
      plugins:[gridPlugin, zeroLinePlugin],
      data:{
        datasets:[{
          data: xy(d.times, d.temp),
          borderColor:cssVar("--color-graph-temp"),
          pointRadius:0,
          borderWidth:2
        }]
      },
      options:opts(grid, tempScale, false, d.times, true)
    })
  );

  // Wind
  const windChart = new Chart(document.getElementById("cWind"), {
    type: "line",
    plugins: [gridPlugin, windArrowPlugin],
    data: {
      datasets:[
        {
          data: xy(d.times, d.wind),
          borderColor:cssVar("--color-graph-wind"),
          pointRadius:0,
          borderWidth:2
        },
        {
          data: xy(d.times, d.gust),
          borderColor:cssVar("--color-graph-gust"),
          borderDash:[4,3],
          pointRadius:0,
          borderWidth:2
        }
      ]
    },
    options: opts(grid, {min: 0})
  });
  windChart.$windDirSampled = d.windDirSampled;
  charts.push(windChart);

  // Humidity
  charts.push(
    new Chart(document.getElementById("cRH"),{
      type:"line",
      plugins:[gridPlugin],
      data:{
        datasets:[{
          data: xy(d.times, d.rh),
          borderColor:cssVar("--color-graph-humidity"),
          pointRadius:0,
          borderWidth:2
        }]
      },
      options:opts(grid)
    })
  );

  // Sun
  charts.push(
    new Chart(document.getElementById("cSun"), {
      type: "bar",
      plugins: [gridPlugin],
      parsing: false,
      data: {
        datasets: [{
          data: xy(d.times, d.sun),
          backgroundColor: cssVar("--color-graph-sun"),
          barPercentage: .8
        }]
      },
      options: opts(grid, {beginAtZero: false, max: 60}) // ← X-Achse an
    })
  );

  // Rain
  charts.push(
    new Chart(document.getElementById("cRain"), {
      type: "bar",
      plugins: [gridPlugin],
      parsing: false,
      data: {
        datasets: [{
          data: xy(d.times, d.rain),
          backgroundColor: cssVar("--color-graph-rain"),
          barPercentage: .8
        }]
      },
      options: opts(grid, {suggestedMax: 0.5}, true, d.times) // ← X-Achse an
    })
  );
}

/* ===============================
   Helper functions
   =============================== */
function opts(grid, y = {}, showX = false, times = null, showXTop = false) {
  const xMin = todayMidnight();
  console.log(xMin);
  const xMax = new Date(xMin);
  xMax.setDate(xMax.getDate() + 3);
  xMax.setHours(23, 59, 59, 999);
  return{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{legend:{display:false},grid:{days:grid.days,hours:grid.hours}},
    scales: {
      x: {
        type: "time",
        min: xMin,
        suggestedMin: xMin,
        max: xMax,
        time: {
          unit: "hour",
          stepSize: 1
        },
        display: showX,
        ticks: showX && times ? {
          autoSkip: false,
          source: "data",
          callback: (value) => {
            const d = new Date(value);
            const h = d.getHours();
            return [0, 6, 12, 18].includes(h)
              ? d.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })
              : "";
          },
          maxRotation: 0,
          minRotation: 0,
          font: { size: cssVar("--font-size-small") },
          color: cssVar("--color-text-light")
        } : undefined,
        grid: { display: false }
      },
      xTop: {
        type: "time",
        min: xMin,
        suggestedMin: xMin,
        max: xMax,
        position: "top",
        time: {
          unit: "hour",
          stepSize: 24
        },
        display: showXTop,
        ticks: showXTop && times ? {
          autoSkip: true,
          callback: (value) => {
            const d = new Date(value);
            const h = d.getHours();
            console.log(d.toLocaleDateString("de-DE", { weekday: "short", day: "2-digit", month: "2-digit" }).replace(',',''));
            return (h == 13)
              ? d.toLocaleDateString("de-DE", { weekday: "short", day: "2-digit", month: "2-digit" }).replace(',','')
              : "";
          },
          maxRotation: 0,
          minRotation: 0,
          font: { size: cssVar("--font-size-small"), weight: 'bold' },
          color: cssVar("--color-text")
        } : undefined,
        grid: { display: false }
      },
      y: {
        afterFit(scale) {
          scale.width = 28;
        },
        grid: {
          color: cssVar("--color-text-light"),
          lineWidth: 0.1
        },
        ...y
      }
    }
  };
}

function cssVar(name) {
  return getComputedStyle(document.documentElement)
    .getPropertyValue(name)
    .trim();
}

function gridInfo(times) {
  const days = [], hours = [];
  times.forEach(t => {
    if (!(t instanceof Date) || isNaN(t)) return;

    const h = t.getHours();
    if (h === 0) days.push({ t });
    if ([0, 6, 12, 18].includes(h)) hours.push({ t });
  });
  return { days, hours };
}

function display_error(message) {
  let e = document.getElementById("error");
  e.textContent = message;
  e.style.display = "block";
}

function changeDarkmode(value) {
  localStorage.setItem("darkmode", value);
  window.location = '';
}

function setDarkmodeFromStorage() {
  const mode = localStorage.getItem("darkmode") ?? 2;
  const root = document.documentElement;

  document.getElementById("darkmodeSelector").value = mode;

  if (mode === "1") {
    root.dataset.theme = "dark";
  } else if (mode === "0") {
    delete root.dataset.theme;
  } else {
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      root.dataset.theme = "dark";
    } else {
      delete root.dataset.theme;
    }
  }
}

function xy(times, values) {
  return times.map((t, i) =>
    values[i] == null ? null : { x: t, y: values[i] }
  ).filter(Boolean);
}

function todayMidnight() {
  const now = new Date();
  return new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
    1, 0, 0, 0
  );
}
</script>

</body>
</html>
